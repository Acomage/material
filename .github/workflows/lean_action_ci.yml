name: Lean + Futhark + ISPC CI

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      # 1. 系统依赖（C / 图像库）
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            libc++-dev \
            libc++abi-dev \
            libpng-dev \
            libturbojpeg-dev \
            libuv1-dev \
            libgmp-dev \
            zlib1g-dev \
            curl \
            tar

      # 2. 安装 ISPC（官方新版本，避免 cbrt 问题）
      - name: Install ISPC
        run: |
          ISPC_VERSION=1.28.2
          curl -L -o ispc.tar.gz \
            https://github.com/ispc/ispc/releases/download/v${ISPC_VERSION}/ispc-v${ISPC_VERSION}-linux.tar.gz
          tar -xzf ispc.tar.gz

          # 安装 ispc 可执行文件
          sudo install -m 0755 ispc-v${ISPC_VERSION}-linux/bin/ispc /usr/local/bin/ispc

          # 验证版本
          ispc --version

      # 3. 安装 Futhark
      - name: Install Futhark
        uses: diku-dk/install-futhark@v1.1.0
        with:
          version: nightly

      # 4. futhark pkg sync（只做同步）
      - name: Futhark pkg sync
        working-directory: ./Material/Extract/futhark
        run: |
          futhark pkg sync

      # 5. Lean build（最后！）
      - name: Build Lean project
        uses: leanprover/lean-action@v1
        env:
          LEAN_CC: clang

